<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whisper Transcriber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <div class="logo-section">
          <h1>Whisper Transcriber</h1>
          <p>Upload an audio file, pick a model, and get instant text output in your preferred format.</p>
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-messages">
            {% for category, message in messages %}
              {% if category != "transcription" %}
                <div class="flash {{ category }}">{{ message }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% if error %}
        <div class="flash error">
          {{ error }}
        </div>
      {% endif %}

      <section class="card">
        <form action="/" method="post" enctype="multipart/form-data">
          <div class="upload-section">
            <label class="field">
              <span>Audio file</span>
              <div id="dropZone" class="drop-zone">
                <div class="drop-zone-content">
                  <svg class="drop-zone-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" fill="currentColor"/>
                  </svg>
                  <p class="drop-zone-text">Drag & drop your audio file here</p>
                  <p class="drop-zone-hint">or click to browse</p>
                  <p class="drop-zone-formats">Supported: MP3, WAV, OGG, FLAC, M4A</p>
                </div>
                <input type="file" id="audioFileInput" name="audio_file" accept="audio/*" required class="hidden-file-input" />
              </div>
              <div id="filePreviewContainer" class="file-preview-container"></div>
            </label>
          </div>

          <div class="options-grid">
            <label class="field">
              <span>Model</span>
              <select name="model">
                {% for model in supported_models %}
                  <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>
                    {{ model|capitalize }}
                  </option>
                {% endfor %}
              </select>
            </label>

            <label class="field">
              <span>Output format</span>
              <select name="format">
                {% for fmt in supported_formats %}
                  <option value="{{ fmt }}" {% if fmt == selected_format %}selected{% endif %}>
                    {{ fmt|upper }}
                  </option>
                {% endfor %}
              </select>
            </label>

            <label class="field">
              <span>Language</span>
              <select name="language">
                <option value="" {% if not language %}selected{% endif %}>Auto-detect</option>
                <option value="en" {% if language == 'en' %}selected{% endif %}>English</option>
                <option value="zh" {% if language == 'zh' %}selected{% endif %}>Chinese</option>
                <option value="de" {% if language == 'de' %}selected{% endif %}>German</option>
                <option value="es" {% if language == 'es' %}selected{% endif %}>Spanish</option>
                <option value="ru" {% if language == 'ru' %}selected{% endif %}>Russian</option>
                <option value="ko" {% if language == 'ko' %}selected{% endif %}>Korean</option>
                <option value="fr" {% if language == 'fr' %}selected{% endif %}>French</option>
                <option value="ja" {% if language == 'ja' %}selected{% endif %}>Japanese</option>
                <option value="pt" {% if language == 'pt' %}selected{% endif %}>Portuguese</option>
                <option value="tr" {% if language == 'tr' %}selected{% endif %}>Turkish</option>
                <option value="pl" {% if language == 'pl' %}selected{% endif %}>Polish</option>
                <option value="ca" {% if language == 'ca' %}selected{% endif %}>Catalan</option>
                <option value="nl" {% if language == 'nl' %}selected{% endif %}>Dutch</option>
                <option value="ar" {% if language == 'ar' %}selected{% endif %}>Arabic</option>
                <option value="sv" {% if language == 'sv' %}selected{% endif %}>Swedish</option>
                <option value="it" {% if language == 'it' %}selected{% endif %}>Italian</option>
                <option value="id" {% if language == 'id' %}selected{% endif %}>Indonesian</option>
                <option value="hi" {% if language == 'hi' %}selected{% endif %}>Hindi</option>
                <option value="fi" {% if language == 'fi' %}selected{% endif %}>Finnish</option>
                <option value="vi" {% if language == 'vi' %}selected{% endif %}>Vietnamese</option>
                <option value="he" {% if language == 'he' %}selected{% endif %}>Hebrew</option>
                <option value="uk" {% if language == 'uk' %}selected{% endif %}>Ukrainian</option>
                <option value="el" {% if language == 'el' %}selected{% endif %}>Greek</option>
                <option value="ms" {% if language == 'ms' %}selected{% endif %}>Malay</option>
                <option value="cs" {% if language == 'cs' %}selected{% endif %}>Czech</option>
                <option value="ro" {% if language == 'ro' %}selected{% endif %}>Romanian</option>
                <option value="da" {% if language == 'da' %}selected{% endif %}>Danish</option>
                <option value="hu" {% if language == 'hu' %}selected{% endif %}>Hungarian</option>
                <option value="ta" {% if language == 'ta' %}selected{% endif %}>Tamil</option>
                <option value="no" {% if language == 'no' %}selected{% endif %}>Norwegian</option>
                <option value="th" {% if language == 'th' %}selected{% endif %}>Thai</option>
                <option value="ur" {% if language == 'ur' %}selected{% endif %}>Urdu</option>
                <option value="hr" {% if language == 'hr' %}selected{% endif %}>Croatian</option>
                <option value="bg" {% if language == 'bg' %}selected{% endif %}>Bulgarian</option>
                <option value="lt" {% if language == 'lt' %}selected{% endif %}>Lithuanian</option>
                <option value="la" {% if language == 'la' %}selected{% endif %}>Latin</option>
                <option value="mi" {% if language == 'mi' %}selected{% endif %}>Maori</option>
                <option value="ml" {% if language == 'ml' %}selected{% endif %}>Malayalam</option>
                <option value="cy" {% if language == 'cy' %}selected{% endif %}>Welsh</option>
                <option value="sk" {% if language == 'sk' %}selected{% endif %}>Slovak</option>
                <option value="te" {% if language == 'te' %}selected{% endif %}>Telugu</option>
                <option value="fa" {% if language == 'fa' %}selected{% endif %}>Persian</option>
                <option value="lv" {% if language == 'lv' %}selected{% endif %}>Latvian</option>
                <option value="bn" {% if language == 'bn' %}selected{% endif %}>Bengali</option>
                <option value="sr" {% if language == 'sr' %}selected{% endif %}>Serbian</option>
                <option value="az" {% if language == 'az' %}selected{% endif %}>Azerbaijani</option>
                <option value="sl" {% if language == 'sl' %}selected{% endif %}>Slovenian</option>
                <option value="kn" {% if language == 'kn' %}selected{% endif %}>Kannada</option>
                <option value="et" {% if language == 'et' %}selected{% endif %}>Estonian</option>
                <option value="mk" {% if language == 'mk' %}selected{% endif %}>Macedonian</option>
                <option value="br" {% if language == 'br' %}selected{% endif %}>Breton</option>
                <option value="eu" {% if language == 'eu' %}selected{% endif %}>Basque</option>
                <option value="is" {% if language == 'is' %}selected{% endif %}>Icelandic</option>
                <option value="hy" {% if language == 'hy' %}selected{% endif %}>Armenian</option>
                <option value="ne" {% if language == 'ne' %}selected{% endif %}>Nepali</option>
                <option value="mn" {% if language == 'mn' %}selected{% endif %}>Mongolian</option>
                <option value="bs" {% if language == 'bs' %}selected{% endif %}>Bosnian</option>
                <option value="kk" {% if language == 'kk' %}selected{% endif %}>Kazakh</option>
                <option value="sq" {% if language == 'sq' %}selected{% endif %}>Albanian</option>
                <option value="sw" {% if language == 'sw' %}selected{% endif %}>Swahili</option>
                <option value="gl" {% if language == 'gl' %}selected{% endif %}>Galician</option>
                <option value="mr" {% if language == 'mr' %}selected{% endif %}>Marathi</option>
                <option value="pa" {% if language == 'pa' %}selected{% endif %}>Punjabi</option>
                <option value="si" {% if language == 'si' %}selected{% endif %}>Sinhala</option>
                <option value="km" {% if language == 'km' %}selected{% endif %}>Khmer</option>
                <option value="sn" {% if language == 'sn' %}selected{% endif %}>Shona</option>
                <option value="yo" {% if language == 'yo' %}selected{% endif %}>Yoruba</option>
                <option value="so" {% if language == 'so' %}selected{% endif %}>Somali</option>
                <option value="af" {% if language == 'af' %}selected{% endif %}>Afrikaans</option>
                <option value="oc" {% if language == 'oc' %}selected{% endif %}>Occitan</option>
                <option value="ka" {% if language == 'ka' %}selected{% endif %}>Georgian</option>
                <option value="be" {% if language == 'be' %}selected{% endif %}>Belarusian</option>
                <option value="tg" {% if language == 'tg' %}selected{% endif %}>Tajik</option>
                <option value="sd" {% if language == 'sd' %}selected{% endif %}>Sindhi</option>
                <option value="gu" {% if language == 'gu' %}selected{% endif %}>Gujarati</option>
                <option value="am" {% if language == 'am' %}selected{% endif %}>Amharic</option>
                <option value="yi" {% if language == 'yi' %}selected{% endif %}>Yiddish</option>
                <option value="lo" {% if language == 'lo' %}selected{% endif %}>Lao</option>
                <option value="uz" {% if language == 'uz' %}selected{% endif %}>Uzbek</option>
                <option value="fo" {% if language == 'fo' %}selected{% endif %}>Faroese</option>
                <option value="ht" {% if language == 'ht' %}selected{% endif %}>Haitian Creole</option>
                <option value="ps" {% if language == 'ps' %}selected{% endif %}>Pashto</option>
                <option value="tk" {% if language == 'tk' %}selected{% endif %}>Turkmen</option>
                <option value="nn" {% if language == 'nn' %}selected{% endif %}>Nynorsk</option>
                <option value="mt" {% if language == 'mt' %}selected{% endif %}>Maltese</option>
                <option value="sa" {% if language == 'sa' %}selected{% endif %}>Sanskrit</option>
                <option value="lb" {% if language == 'lb' %}selected{% endif %}>Luxembourgish</option>
                <option value="my" {% if language == 'my' %}selected{% endif %}>Myanmar</option>
                <option value="bo" {% if language == 'bo' %}selected{% endif %}>Tibetan</option>
                <option value="tl" {% if language == 'tl' %}selected{% endif %}>Tagalog</option>
                <option value="mg" {% if language == 'mg' %}selected{% endif %}>Malagasy</option>
                <option value="as" {% if language == 'as' %}selected{% endif %}>Assamese</option>
                <option value="tt" {% if language == 'tt' %}selected{% endif %}>Tatar</option>
                <option value="haw" {% if language == 'haw' %}selected{% endif %}>Hawaiian</option>
                <option value="ln" {% if language == 'ln' %}selected{% endif %}>Lingala</option>
                <option value="ha" {% if language == 'ha' %}selected{% endif %}>Hausa</option>
                <option value="ba" {% if language == 'ba' %}selected{% endif %}>Bashkir</option>
                <option value="jw" {% if language == 'jw' %}selected{% endif %}>Javanese</option>
                <option value="su" {% if language == 'su' %}selected{% endif %}>Sundanese</option>
              </select>
            </label>
          </div>

          <button type="submit" class="primary-btn">Transcribe Audio</button>
        </form>
        
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="loading-text">Transcribing audio file...</p>
          <p class="loading-subtext">This may take a few moments depending on file size and model.</p>
        </div>
      </section>

      {% if transcription %}
        <section class="card transcription-card">
          <div class="transcription-header">
            <h2>Transcription Result</h2>
            <div class="action-buttons">
              <button id="copyBtn" class="action-btn" title="Copy to clipboard">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M16 1H4C2.89543 1 2 1.89543 2 3V17H4V3H16V1Z" fill="currentColor"/>
                  <path d="M15 5H18C19.1046 5 20 5.89543 20 7V21C20 22.1046 19.1046 23 18 23H8C6.89543 23 6 22.1046 6 21V7C6 5.89543 6.89543 5 8 5H11V3H8C5.79086 3 4 4.79086 4 7V21C4 23.2091 5.79086 25 8 25H18C20.2091 25 22 23.2091 22 21V7C22 4.79086 20.2091 3 18 3H15V5Z" fill="currentColor"/>
                </svg>
                Copy
              </button>
              <a id="downloadLink" class="action-btn" title="Download as file">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 16L16 11H13V4H11V11H8L12 16ZM20 18H4V11H2V18C2 19.103 2.897 20 4 20H20C21.103 20 22 19.103 22 18V11H20V18Z" fill="currentColor"/>
                </svg>
                Download
              </a>
            </div>
          </div>
          
          <div class="transcription-content">
            <pre id="transcriptionText" class="transcription-text">{{ transcription }}</pre>
          </div>
          
          <p class="hint">First request may take longer while the model downloads.</p>
        </section>
      {% endif %}
    </main>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const audioFileInput = document.getElementById('audioFileInput');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        let currentFile = null;

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Highlight drop zone when dragging files over it
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          dropZone.classList.add('dragover');
        }

        function unhighlight() {
          dropZone.classList.remove('dragover');
        }

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles(files);
        }

        // Handle file input change
        audioFileInput.addEventListener('change', function() {
          handleFiles(this.files);
        });

        // Process files
        function handleFiles(files) {
          if (files.length === 0) return;
          
          const file = files[0];
          
          // Validate file type
          if (!file.type.startsWith('audio/')) {
            alert('Please upload an audio file (MP3, WAV, OGG, FLAC, M4A)');
            return;
          }

          // Update current file
          currentFile = file;
          
          // Update file input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          audioFileInput.files = dataTransfer.files;

          // Show file preview
          showFilePreview(file);
        }

        // Display file preview
        function showFilePreview(file) {
          filePreviewContainer.innerHTML = '';
          
          const previewCard = document.createElement('div');
          previewCard.className = 'file-preview-card';
          
          const fileSize = formatFileSize(file.size);
          
          previewCard.innerHTML = `
            <div class="file-preview-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" fill="currentColor"/>
              </svg>
            </div>
            <div class="file-preview-info">
              <div class="file-preview-name">${escapeHtml(file.name)}</div>
              <div class="file-preview-size">${fileSize}</div>
            </div>
            <button type="button" class="file-preview-delete" title="Remove file" aria-label="Remove file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
              </svg>
            </button>
          `;
          
          filePreviewContainer.appendChild(previewCard);
          
          // Hide the drop zone file input to prevent it from covering the preview
          audioFileInput.style.display = 'none';
          
          // Add delete functionality
          const deleteBtn = previewCard.querySelector('.file-preview-delete');
          deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            removeFile();
          });
        }

        // Remove file
        function removeFile() {
          currentFile = null;
          audioFileInput.value = '';
          audioFileInput.style.display = 'block';
          filePreviewContainer.innerHTML = '';
        }

        // Format file size
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
          const map = {
            '&': '&',
            '<': '<',
            '>': '>',
            '"': '"',
            "'": '&#039;'
          };
          return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Show loading indicator when form is submitted
        const form = document.querySelector('form');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        if (form && loadingIndicator) {
          form.addEventListener('submit', function(e) {
            // Check if file is selected
            const fileInput = document.getElementById('audioFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
              return;
            }
            
            // Show loading indicator
            loadingIndicator.style.display = 'flex';
            
            // Hide the upload form during processing
            form.style.display = 'none';
          });
        }
        
        // Copy to clipboard functionality
        const copyBtn = document.getElementById('copyBtn');
        if (copyBtn) {
          copyBtn.addEventListener('click', function() {
            const transcriptionText = document.getElementById('transcriptionText');
            const textToCopy = transcriptionText.textContent || transcriptionText.innerText;
            
            navigator.clipboard.writeText(textToCopy)
              .then(() => {
                // Show feedback
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span>Copied!</span>';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                  copyBtn.innerHTML = originalText;
                  copyBtn.classList.remove('copied');
                }, 2000);
              })
              .catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy text to clipboard');
              });
          });
        }
        
        // Download functionality
        const downloadLink = document.getElementById('downloadLink');
        const transcriptionText = document.getElementById('transcriptionText');
        if (downloadLink && transcriptionText) {
          downloadLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            const content = transcriptionText.textContent || transcriptionText.innerText;
            const format = "{{ selected_format }}";
            const filename = `transcription.${format}`;
            
            // Create blob and download link
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
            }, 100);
          });
        }
      });
    </script>
  </body>
</html>